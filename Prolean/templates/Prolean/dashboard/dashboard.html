{% extends 'Prolean/dashboard/base_student.html' %}
{% load static price_filters %}

{% block student_header_title %}
    Bonjour, <span class="text-gradient">{% if user.is_authenticated %}{{ user.first_name|default:profile.full_name|cut:" " }}{% else %}Cher Visiteur{% endif %}</span> üëã
{% endblock %}

{% block student_header_subtitle %}
    {% if user.is_authenticated %}Content de vous revoir ! Pr√™t pour votre prochaine le√ßon ?{% else %}Bienvenue sur votre espace Prolean. Connectez-vous pour commencer.{% endif %}
{% endblock %}

{% block student_content %}
{% if is_guest %}
<!-- Blocking Message for Unauthenticated Users -->
<div class="flex items-center justify-center min-h-[60vh] py-12 px-4">
    <div class="max-w-md w-full text-center animate-in">
        <div class="size-24 rounded-[32px] bg-[#FF6B00]/10 text-[#FF6B00] flex items-center justify-center mx-auto mb-8">
            <span class="material-symbols-outlined text-5xl">lock</span>
        </div>
        <h2 class="text-3xl font-black mb-4" style="color: var(--stu-text-main);">Acc√®s r√©serv√©</h2>
        <p class="font-medium leading-relaxed mb-10" style="color: var(--stu-text-muted);">
            Veuillez vous connecter ou cr√©er un compte pour acc√©der √† votre espace personnel.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="{% url 'Prolean:login' %}" class="px-8 py-4 bg-[#FF6B00] text-white rounded-xl font-black text-sm uppercase tracking-widest hover:scale-105 transition-all shadow-xl shadow-[#FF6B00]/20">
                Se connecter
            </a>
            <a href="{% url 'Prolean:register' %}" class="px-8 py-4 bg-white dark:bg-neutral-800 text-primary dark:text-white border-2 border-accent-green rounded-xl font-black text-sm uppercase tracking-widest hover:scale-105 transition-all">
                S'inscrire
            </a>
        </div>
    </div>
</div>
{% elif profile.status == 'ACTIVE' %}

<!-- Account Status Header -->
<div class="flex flex-wrap items-center gap-6 mb-12 animate-in">
    <div class="glass-card px-6 py-4 flex items-center gap-4 border-l-4 border-l-[#FF6B00] bg-white/40 dark:bg-black/40">
        <div class="size-12 rounded-xl bg-accent-green/10 text-accent-green flex items-center justify-center">
            <span class="material-symbols-outlined font-bold">account_balance_wallet</span>
        </div>
        <div class="price-container">
            <p class="text-[10px] font-black uppercase tracking-widest opacity-50" style="color: var(--stu-text-muted);">Montant Pay√©</p>
            <p class="text-xl font-black text-premium-gradient" data-price-mad="{{ amount_paid|default:0 }}">
                {{ amount_paid|convert_price:request|format_currency:request.session.preferred_currency }}
            </p>
        </div>
    </div>

    <div class="glass-card px-6 py-4 flex items-center gap-4 border-l-4 {% if amount_remaining > 0 %}border-l-amber-500{% else %}border-l-accent-green{% endif %} bg-white/40 dark:bg-black/40">
        <div class="size-12 rounded-xl {% if amount_remaining > 0 %}bg-amber-500/10 text-amber-500{% else %}bg-accent-green/10 text-accent-green{% endif %} flex items-center justify-center">
            <span class="material-symbols-outlined font-bold">pending_actions</span>
        </div>
        <div class="price-container">
            <p class="text-[10px] font-black uppercase tracking-widest opacity-50" style="color: var(--stu-text-muted);">Reste √† Payer</p>
            <p class="text-xl font-black {% if amount_remaining > 0 %}text-amber-500{% else %}text-accent-green{% endif %}" data-price-mad="{{ amount_remaining|default:0 }}">
                {{ amount_remaining|convert_price:request|format_currency:request.session.preferred_currency }}
            </p>
        </div>
    </div>

    <div class="ml-auto">
        <span class="status-badge badge-success flex items-center gap-2 py-2 px-4 shadow-sm">
            <span class="size-2 bg-green-500 rounded-full animate-pulse"></span>
            Acc√®s {{ profile.get_status_display }}
        </span>
    </div>
</div>

<!-- Live Session Spotlight -->
{% if active_streams %}
<div class="glass-card mb-12 p-1 overflow-hidden animate-in delay-1 overflow-hidden">
    <div class="bg-gradient-to-r from-neutral-900 to-neutral-800 dark:from-black dark:to-neutral-900 rounded-[22px] p-8 flex flex-col md:flex-row items-center justify-between gap-8 relative overflow-hidden">
        <div class="absolute top-0 right-0 -mr-20 -mt-20 size-64 bg-accent-green/20 rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 left-0 -ml-20 -mb-20 size-64 bg-brand/20 rounded-full blur-3xl"></div>
        
        <div class="flex items-center gap-6 relative z-10">
            <div class="size-20 rounded-2xl bg-white/5 backdrop-blur-md flex items-center justify-center border border-white/10 text-accent-green">
                <span class="material-symbols-outlined text-4xl animate-pulse">videocam</span>
            </div>
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <span class="px-3 py-1 bg-accent-green text-white rounded-full text-[10px] font-black uppercase tracking-widest shadow-lg shadow-accent-green/20">EN DIRECT</span>
                    <span class="text-neutral-400 text-xs font-bold">{{ active_streams.0.session.professor.profile.full_name }}</span>
                </div>
                <h2 class="text-2xl font-black text-white leading-tight">
                    {{ active_streams.0.session.formations.all.0.title }}
                </h2>
            </div>
        </div>

        <a href="{% url 'Prolean:live_session' active_streams.0.id %}" class="px-10 py-4 bg-accent-green text-white rounded-xl font-black text-sm uppercase tracking-widest hover:scale-105 transition-all shadow-xl shadow-accent-green/20 relative z-10 group">
            Rejoindre maintenant
            <span class="inline-block transition-transform group-hover:translate-x-1 ml-2">‚Üí</span>
        </a>
    </div>
</div>
{% endif %}

<!-- Quick Stats & Next Session -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
    <!-- Next Session Card -->
    <div class="lg:col-span-2 glass-card p-1 animate-in delay-2 hover-lift">
        <div class="p-8 flex flex-col md:flex-row items-center gap-8">
            <div class="size-24 rounded-3xl bg-surface-hover text-brand flex flex-col items-center justify-center border border-stu-border relative overflow-hidden group/date">
                <div class="absolute inset-0 bg-brand opacity-0 group-hover/date:opacity-10 transition-opacity"></div>
                <span class="text-2xl font-black relative z-10">{{ next_seance.date|date:"d"|default:"--" }}</span>
                <span class="text-[10px] font-black uppercase tracking-widest opacity-60 relative z-10">{{ next_seance.date|date:"M"|default:"---" }}</span>
            </div>
            <div class="flex-1 text-center md:text-left">
                <h3 class="text-[10px] font-black uppercase tracking-[0.2em] mb-2 opacity-60">Prochaine S√©ance</h3>
                <h2 class="text-2xl font-black mb-3" style="color: var(--stu-text-main);">
                    {% if next_seance %}{{ next_seance.title }}{% else %}Aucune s√©ance planifi√©e{% endif %}
                </h2>
                <div class="flex flex-wrap items-center justify-center md:justify-start gap-6 text-sm font-semibold" style="color: var(--stu-text-muted);">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg opacity-60">schedule</span>
                        {{ next_seance.time|time:"H:i"|default:"--:--" }}
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg opacity-60">location_on</span>
                        En ligne via Prolean Live
                    </div>
                </div>
            </div>
            <div class="w-full md:w-auto">
                <a href="{% url 'Prolean:student_schedule' %}" class="btn-primary inline-flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">calendar_month</span>
                    Mon Agenda
                </a>
            </div>
        </div>
    </div>

    <!-- Progress Card -->
    <div class="glass-card p-8 flex flex-col justify-between animate-in delay-2 hover-lift">
        <div>
            <div class="flex items-center justify-between mb-8">
                <h3 class="text-[10px] font-black uppercase tracking-[0.2em] opacity-60">Ma Progression</h3>
                <span class="size-8 rounded-lg bg-accent-green/10 text-accent-green flex items-center justify-center">
                    <span class="material-symbols-outlined text-lg">insights</span>
                </span>
            </div>
            <div class="flex items-end justify-between mb-4">
                <span class="text-4xl font-black text-premium-gradient">{{ watch_percentage }}%</span>
                <span class="text-[10px] font-bold uppercase tracking-widest opacity-40">Objectif: 100%</span>
            </div>
            <div class="w-full h-3 bg-surface-hover rounded-full overflow-hidden p-0.5 border border-stu-border">
                <div class="h-full bg-premium-gradient rounded-full transition-all duration-1000 shadow-[0_0_15px_rgba(52,116,92,0.3)]" style="width: {{ watch_percentage }}%"></div>
            </div>
        </div>
    </div>
</div>

<!-- Professor Messages -->
<div class="mb-12 animate-in delay-3">
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-3">
            <div class="size-10 rounded-xl bg-accent-green/10 text-accent-green flex items-center justify-center">
                <span class="material-symbols-outlined">campaign</span>
            </div>
            <h2 class="text-2xl font-black">Actualit√©s & Messages</h2>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for note in notifications|slice:":2" %}
        <div class="glass-card p-8 flex items-start gap-6 relative overflow-hidden group hover-lift border-t-4 border-t-accent-green">
            <div class="size-14 rounded-2xl bg-surface-hover text-brand flex items-center justify-center shrink-0 shadow-inner group-hover:scale-110 transition-transform">
                <span class="material-symbols-outlined text-2xl">mark_chat_unread</span>
            </div>
            <div class="flex-1">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-black text-lg">{{ note.title }}</h4>
                    <span class="text-[10px] font-bold uppercase tracking-wider opacity-40">{{ note.created_at|timesince }}</span>
                </div>
                <p class="text-sm leading-relaxed opacity-70 mb-4 line-clamp-2">{{ note.message }}</p>
                <button class="text-[10px] font-black uppercase tracking-widest text-brand flex items-center gap-2 hover:gap-3 transition-all">
                    Lire le message complet
                    <span class="material-symbols-outlined text-sm">arrow_forward</span>
                </button>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full py-16 glass-card flex flex-col items-center justify-center text-center border-dashed border-2">
            <div class="size-20 rounded-full bg-surface-hover flex items-center justify-center mb-6 opacity-30">
                <span class="material-symbols-outlined text-4xl">notifications_off</span>
            </div>
            <p class="font-bold uppercase text-[10px] tracking-[0.2em] opacity-40">Aucune annonce pour le moment</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- My Formations -->
<div id="formations" class="">
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-3">
            <div class="size-10 rounded-xl bg-brand/10 text-brand flex items-center justify-center">
                <span class="material-symbols-outlined">school</span>
            </div>
            <h2 class="text-2xl font-black">Mes Formations</h2>
        </div>
        <div class="px-5 py-2 bg-surface-hover border border-stu-border rounded-2xl text-[10px] font-black uppercase tracking-[0.1em] shadow-sm">
            {{ my_formations.count }} √âl√©ment{{ my_formations.count|pluralize }} Actif{{ my_formations.count|pluralize }}
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6 lg:gap-8">
        {% for training in my_formations %}
        <div class="bg-white dark:bg-neutral-800 rounded-2xl sm:rounded-3xl overflow-hidden shadow-sm border border-neutral-100 dark:border-neutral-700 group flex flex-col h-full">
            <!-- Thumbnail Container -->
            <div class="relative h-48 sm:h-56 overflow-hidden">
                {% if training.thumbnail %}
                <img src="{{ training.thumbnail }}" 
                    alt="{{ training.title }}"
                    class="w-full h-full object-cover"
                    loading="lazy">
                {% else %}
                <div class="w-full h-full bg-gradient-to-br from-accent-green to-accent-blue flex items-center justify-center">
                    <span class="material-symbols-outlined text-white text-4xl sm:text-5xl">school</span>
                </div>
                {% endif %}
                
                <!-- Category Badge -->
                <div class="absolute top-3 sm:top-4 left-3 sm:left-4">
                    <span class="inline-block px-2 sm:px-3 py-1 sm:py-1.5 bg-white/90 dark:bg-neutral-900/90 backdrop-blur-sm text-[10px] sm:text-xs font-bold rounded-lg shadow-sm">
                        {% if training.category_caces %}üèóÔ∏è CACES
                        {% elif training.category_electricite %}‚ö° √âLECTRICIT√â
                        {% elif training.category_soudage %}üî• SOUDAGE
                        {% elif training.category_securite %}üõ°Ô∏è S√âCURIT√â
                        {% elif training.category_management %}üë®‚Äçüíº MANAGEMENT
                        {% else %}üìö FORMATION{% endif %}
                    </span>
                </div>
                
                <!-- Status Badge -->
                <div class="absolute top-3 sm:top-4 right-3 sm:right-4">
                    <span class="inline-flex items-center gap-1 px-2 sm:px-3 py-1 sm:py-1.5 bg-accent-green text-white text-[10px] sm:text-xs font-bold rounded-lg shadow-lg">
                        <span class="size-1.5 bg-white rounded-full animate-pulse"></span>
                        <span>EN COURS</span>
                    </span>
                </div>
            </div>

            <!-- Content -->
            <div class="p-4 sm:p-6 flex flex-col flex-grow">
                <!-- Title -->
                <h3 class="text-lg sm:text-xl font-bold text-primary dark:text-white mb-2 sm:mb-3 line-clamp-2 hover:text-accent-green transition-colors">
                    {{ training.title }}
                </h3>

                <!-- Description -->
                <p class="text-xs sm:text-sm text-neutral-500 dark:text-neutral-400 mb-3 sm:mb-4 line-clamp-2 flex-grow">
                    {{ training.short_description|truncatechars:100 }}
                </p>

                <!-- Stats -->
                <div class="grid grid-cols-3 gap-1 sm:gap-2 mb-3 sm:mb-5 pt-3 sm:pt-4 border-t border-neutral-100 dark:border-neutral-700">
                    <div class="text-center">
                        <div class="flex items-center justify-center gap-1 text-accent-green mb-1">
                            <span class="material-symbols-outlined text-xs sm:text-sm">schedule</span>
                            <span class="text-[10px] sm:text-xs font-bold">{{ training.duration_days }}j</span>
                        </div>
                        <span class="text-[10px] sm:text-xs text-neutral-500">Dur√©e</span>
                    </div>
                    <div class="text-center">
                        <div class="flex items-center justify-center gap-1 text-accent-green mb-1">
                            <span class="material-symbols-outlined text-xs sm:text-sm">workspace_premium</span>
                            <span class="text-[10px] sm:text-xs font-bold">{{ training.success_rate|default:95 }}%</span>
                        </div>
                        <span class="text-[10px] sm:text-xs text-neutral-500">R√©ussite</span>
                    </div>
                    <div class="text-center">
                        <div class="flex items-center justify-center gap-1 text-accent-green mb-1">
                            <span class="material-symbols-outlined text-xs sm:text-sm">group</span>
                            <span class="text-[10px] sm:text-xs font-bold">{{ training.max_students|default:20 }}</span>
                        </div>
                        <span class="text-[10px] sm:text-xs text-neutral-500">Max</span>
                    </div>
                </div>

                <!-- Action Button -->
                <div class="mt-auto">
                    <a href="{% url 'Prolean:recorded_videos_list' training.slug %}" 
                       class="w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-accent-green text-white rounded-lg sm:rounded-xl text-xs sm:text-sm font-bold hover:bg-accent-green/90 transition-all flex items-center justify-center gap-1 sm:gap-2 group/btn shadow-lg shadow-accent-green/20">
                        <span>Reprendre le cours</span>
                        <span class="material-symbols-outlined text-xs sm:text-sm group-hover/btn:translate-x-0.5 transition-transform">arrow_forward</span>
                    </a>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full py-24 glass-card flex flex-col items-center justify-center text-center opacity-50 border-dashed border-2">
            <span class="material-symbols-outlined text-6xl mb-6 opacity-20">inventory_2</span>
            <p class="font-bold uppercase text-[10px] tracking-[0.2em] opacity-40">Votre catalogue est vide</p>
            <a href="{% url 'Prolean:home' %}" class="mt-6 text-brand font-black uppercase text-[10px] tracking-widest hover:underline">D√©couvrir nos formations</a>
        </div>
        {% endfor %}
    </div>
</div>


{% else %}
<!-- Pending Account State -->
<div class="flex items-center justify-center min-h-[60vh]">
    <div class="max-w-md w-full text-center">
        <div class="size-24 rounded-[32px] bg-amber-50 dark:bg-amber-900/20 text-amber-500 flex items-center justify-center mx-auto mb-8 animate-bounce">
            <span class="material-symbols-outlined text-5xl">hourglass_top</span>
        </div>
        <h2 class="text-3xl font-black mb-4" style="color: var(--stu-text-main);">Inscription en attente</h2>
        <p class="font-medium leading-relaxed mb-10" style="color: var(--stu-text-muted);">
            Votre dossier est en cours de validation par notre √©quipe p√©dagogique. 
            Vous recevrez une notification par email d√®s que votre acc√®s sera activ√©.
        </p>
        <div class="p-8 glass-card border-dashed border-2 border-amber-200 dark:border-amber-900/50 bg-amber-50/30">
            <h4 class="text-xs font-black text-amber-700 dark:text-amber-400 uppercase tracking-widest mb-4">Besoin d'aide ?</h4>
            <p class="text-sm font-semibold text-amber-900/70 dark:text-amber-500 mb-6">Contactez notre support pour acc√©l√©rer votre validation</p>
            <a href="https://wa.me/212779259942" class="inline-flex items-center gap-2 px-6 py-3 bg-amber-500 text-white rounded-xl font-bold shadow-lg shadow-amber-500/20 hover:bg-amber-600 transition-all">
                <span class="material-symbols-outlined">chat</span>
                Support WhatsApp
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Animation for progress bar
    document.addEventListener('DOMContentLoaded', () => {
        const progressBar = document.querySelector('.bg-accent-green');
        if (progressBar) {
            const width = progressBar.style.width;
            progressBar.style.width = '0%';
            setTimeout(() => {
                progressBar.style.width = width;
            }, 300);
        }
    });
</script>
{% endblock %}


