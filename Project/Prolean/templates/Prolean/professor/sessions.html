{% extends 'Prolean/professor/base_professor.html' %}
{% load static %}

{% block header_title %}Gestion des Sessions{% endblock %}
{% block header_subtitle %}Planification et configuration de vos hubs d'apprentissage.{% endblock %}

{% block professor_content %}
<div class="flex flex-col lg:flex-row gap-8">
    <!-- Main Content: Sessions History -->
    <div class="lg:w-2/3 space-y-6">
        <div class="glass-card overflow-hidden">
            <div class="px-8 py-6 border-b border-prof flex items-center justify-between bg-surface-hover">
                <h2 class="text-[10px] font-black uppercase tracking-[0.2em]" style="color: var(--prof-text-main);">Planning & Historique</h2>
                <span class="text-[10px] font-bold opacity-50 uppercase tracking-widest" style="color: var(--prof-text-muted);">{{ sessions.count }} Sessions</span>
            </div>
            <div class="divide-y border-prof">
                {% for session in sessions %}
                <div class="p-8 group hover:bg-surface-hover transition-all relative overflow-hidden">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-8 relative z-10">
                        <div class="flex items-center gap-6">
                            <!-- Date Badge -->
                            <div class="size-20 rounded-2xl bg-surface-hover border border-prof flex flex-col items-center justify-center text-center shrink-0 shadow-sm group-hover:scale-105 transition-transform" style="background-color: var(--prof-surface);">
                                <span class="text-[10px] font-black uppercase tracking-widest mb-1 opacity-60" style="color: var(--prof-text-muted);">{{ session.start_date|date:"M"|truncatechars:3 }}</span>
                                <span class="text-3xl font-black leading-none" style="color: var(--prof-text-main);">{{ session.start_date|date:"d" }}</span>
                            </div>

                            <!-- Info -->
                            <div>
                                <h3 class="font-black text-xl tracking-tight mb-2" style="color: var(--prof-text-main);">
                                    {% for training in session.formations.all %}
                                        {{ training.title }}
                                        {% if not forloop.last %}<span class="text-brand opacity-50 px-1">+</span>{% endif %}
                                    {% endfor %}
                                </h3>
                                
                                <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                                    <div class="flex items-center gap-2 text-[11px] font-bold opacity-60" style="color: var(--prof-text-muted);">
                                        <span class="material-symbols-outlined text-brand text-sm">calendar_month</span>
                                        {{ session.start_date|date:"d M" }} ‚Äî {{ session.end_date|date:"d M" }}
                                    </div>
                                    <div class="flex items-center gap-2 text-[11px] font-bold opacity-60" style="color: var(--prof-text-muted);">
                                        <span class="material-symbols-outlined text-brand text-sm">location_on</span>
                                        {{ session.city.name|default:"Centre" }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex flex-col items-end gap-3 shrink-0">
                            <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest border border-prof
                                {% if session.status == 'ONGOING' %}badge-success border-transparent{% elif session.status == 'CREATED' %}badge-info border-transparent{% else %}bg-surface-hover text-muted border-prof{% endif %}">
                                {{ session.get_status_display }}
                            </span>
                            
                            <div class="flex items-center gap-2">
                                <button onclick="openNotificationModal('{{ session.id }}', '{% for t in session.formations.all %}{{ t.title|escapejs }}{% endfor %}')" 
                                        class="size-10 rounded-xl border border-prof flex items-center justify-center text-muted hover:text-brand hover:border-brand transition-all glass-card"
                                        title="Notifier">
                                    <span class="material-symbols-outlined text-lg">campaign</span>
                                </button>
                                
                                <button {% if session.status != 'ONGOING' %}disabled{% else %}onclick="toggleSeanceForm('{{ session.id }}')"{% endif %} 
                                        class="px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2
                                        {% if session.status == 'ONGOING' %}bg-brand text-white shadow-lg shadow-brand/20 hover:bg-opacity-90{% else %}bg-surface-hover text-muted cursor-not-allowed opacity-50 border border-prof{% endif %}">
                                    Configurer
                                    <span class="material-symbols-outlined text-xs">edit_calendar</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Inline Seance Management -->
                    <div id="seance-form-{{ session.id }}" class="hidden mt-8 pt-8 border-t border-prof animate-in fade-in slide-in-from-top-4 duration-300">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- List current seances -->
                            <div class="space-y-4">
                                <h4 class="text-[9px] font-black uppercase tracking-[0.3em] mb-4 opacity-50" style="color: var(--prof-text-muted);">S√©ances Programm√©es</h4>
                                {% for seance in session.seances.all %}
                                <div class="flex items-center justify-between p-4 rounded-xl bg-surface-hover border border-prof hover:border-brand transition-colors">
                                    <div class="flex items-center gap-4">
                                        <div class="size-10 rounded-lg bg-white dark:bg-slate-800 shadow-sm flex flex-col items-center justify-center font-black leading-none border border-prof">
                                            <span class="text-[7px] text-muted uppercase tracking-wider">{{ seance.date|date:"M" }}</span>
                                            <span class="text-sm" style="color: var(--prof-text-main);">{{ seance.date|date:"d" }}</span>
                                        </div>
                                        <div>
                                            <div class="text-xs font-black uppercase tracking-tight" style="color: var(--prof-text-main);">{{ seance.title }}</div>
                                            <div class="text-[9px] font-bold opacity-60 uppercase tracking-widest mt-0.5" style="color: var(--prof-text-muted);">{{ seance.get_type_display }} ‚Ä¢ {{ seance.time|time:"H:i" }}</div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="py-8 text-center border-2 border-dashed border-prof rounded-xl opacity-50">
                                    <p class="text-[9px] font-black uppercase tracking-widest" style="color: var(--prof-text-muted);">Aucune s√©ance</p>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Add Seance Form -->
                            <div class="p-6 rounded-2xl bg-surface-hover border border-prof">
                                <h4 class="text-[9px] font-black uppercase tracking-[0.3em] mb-6 flex items-center gap-2" style="color: var(--prof-text-main);">
                                    <span class="material-symbols-outlined text-sm text-brand">add_circle</span> Ajouter une s√©ance
                                </h4>
                                <form action="{% url 'Prolean:add_seance' %}" method="post" class="space-y-4">
                                    {% csrf_token %}
                                    <input type="hidden" name="session_id" value="{{ session.id }}">
                                    
                                    <div>
                                        <input type="text" name="title" placeholder="Titre (ex: Introduction)" 
                                               class="w-full bg-white dark:bg-slate-800 border border-prof rounded-xl px-4 py-3 text-xs font-bold outline-none focus:border-brand transition-all" style="color: var(--prof-text-main);" required>
                                    </div>

                                    <div class="grid grid-cols-2 gap-3">
                                        <select name="type" class="w-full px-4 py-3 rounded-xl bg-white dark:bg-slate-800 border border-prof text-xs font-bold focus:border-brand outline-none" style="color: var(--prof-text-main);" required>
                                            <option value="THEORIQUE">Th√©orique</option>
                                            <option value="PRATIQUE">Pratique</option>
                                        </select>
                                        <input type="text" name="location" placeholder="Lieu..." 
                                               class="w-full px-4 py-3 rounded-xl bg-white dark:bg-slate-800 border border-prof text-xs font-bold focus:border-brand outline-none" style="color: var(--prof-text-main);">
                                    </div>

                                    <div class="grid grid-cols-2 gap-3">
                                        <input type="date" name="date" class="w-full px-4 py-3 rounded-xl bg-white dark:bg-slate-800 border border-prof text-xs font-bold focus:border-brand outline-none" style="color: var(--prof-text-main);" required>
                                        <input type="time" name="time" class="w-full px-4 py-3 rounded-xl bg-white dark:bg-slate-800 border border-prof text-xs font-bold focus:border-brand outline-none" style="color: var(--prof-text-main);" required>
                                    </div>

                                    <button type="submit" class="w-full py-3 bg-brand text-white text-[10px] font-black rounded-xl hover:opacity-90 transition-all shadow-md uppercase tracking-[0.2em]">
                                        Confirmer
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="p-20 text-center">
                    <div class="size-16 bg-surface-hover rounded-2xl flex items-center justify-center mx-auto mb-6 opacity-50">
                        <span class="material-symbols-outlined text-4xl" style="color: var(--prof-text-muted);">event_busy</span>
                    </div>
                    <h4 class="text-xl font-black tracking-tight mb-2" style="color: var(--prof-text-main);">Aucune session</h4>
                    <p class="text-sm opacity-60" style="color: var(--prof-text-muted);">Vos sessions planifi√©es appara√Ætront ici.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Sidebar: New Session Form (Admin) -->
    {% if user.profile.role == 'ADMIN' %}
    <div class="lg:w-1/3">
        <div class="glass-card p-8 sticky top-24">
            <div class="flex items-center gap-4 mb-8">
                <div class="size-12 rounded-xl bg-brand text-white flex items-center justify-center shadow-lg shadow-brand/20">
                    <span class="material-symbols-outlined text-2xl">add</span>
                </div>
                <div>
                    <h2 class="text-[10px] font-black uppercase tracking-[0.2em]" style="color: var(--prof-text-main);">Configuration</h2>
                    <p class="text-[9px] font-bold opacity-50 uppercase tracking-wider" style="color: var(--prof-text-muted);">Nouvelle Cohorte</p>
                </div>
            </div>
            
            <form method="post" class="space-y-6">
                {% csrf_token %}
                <div class="space-y-2">
                    <label class="text-[9px] font-black uppercase tracking-widest ml-1 opacity-60" style="color: var(--prof-text-muted);">Formations</label>
                    <select name="training_ids" class="w-full px-4 py-3 rounded-xl bg-surface-hover border border-prof text-xs font-bold outline-none focus:border-brand h-32 scroll-hide" style="color: var(--prof-text-main);" multiple required>
                        {% for t in trainings %}
                        <option value="{{ t.id }}" class="py-1">{{ t.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[9px] font-black uppercase tracking-widest ml-1 opacity-60" style="color: var(--prof-text-muted);">D√©but</label>
                        <input type="date" name="start_date" class="w-full px-4 py-3 rounded-xl bg-surface-hover border border-prof text-xs font-bold outline-none focus:border-brand" style="color: var(--prof-text-main);" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black uppercase tracking-widest ml-1 opacity-60" style="color: var(--prof-text-muted);">Fin</label>
                        <input type="date" name="end_date" class="w-full px-4 py-3 rounded-xl bg-surface-hover border border-prof text-xs font-bold outline-none focus:border-brand" style="color: var(--prof-text-main);" required>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label class="text-[9px] font-black uppercase tracking-widest ml-1 opacity-60" style="color: var(--prof-text-muted);">Ville</label>
                    <select name="city_id" class="w-full px-4 py-3 rounded-xl bg-surface-hover border border-prof text-xs font-bold outline-none focus:border-brand" style="color: var(--prof-text-main);" required>
                        {% for city in cities %}
                        <option value="{{ city.id }}">{{ city.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="p-4 rounded-xl bg-surface-hover border border-prof flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-brand">sensors</span>
                        <div>
                            <div class="text-[10px] font-black uppercase tracking-widest" style="color: var(--prof-text-main);">Live Digital</div>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="is_live" class="sr-only peer">
                        <div class="w-10 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand shadow-inner"></div>
                    </label>
                </div>
                
                <button type="submit" class="w-full py-4 bg-prof-text-main text-prof-bg font-black rounded-xl hover:opacity-90 transition-all shadow-lg uppercase tracking-[0.2em] text-[10px]" style="background-color: var(--prof-text-main); color: var(--prof-bg);">
                    Cr√©er le Hub
                </button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<!-- Notification Modal -->
<div id="notification-modal" class="fixed inset-0 z-[100] hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-md" onclick="closeNotificationModal()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg p-4 z-10">
        <div class="glass-card p-8 animate-in zoom-in-95 duration-200" style="background: var(--prof-bg);">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-black uppercase tracking-tight" style="color: var(--prof-text-main);">Diffusion Annonce</h3>
                    <p id="modal-session-name" class="text-[10px] font-black text-brand mt-1 uppercase tracking-widest"></p>
                </div>
                <button onclick="closeNotificationModal()" class="size-10 rounded-xl hover:bg-surface-hover flex items-center justify-center transition-all" style="color: var(--prof-text-muted);">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <form id="notification-form" method="POST" class="space-y-6">
                {% csrf_token %}
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase tracking-widest ml-1 opacity-60" style="color: var(--prof-text-muted);">Sujet</label>
                    <input type="text" name="title" placeholder="Ex: Changement d'horaire..." 
                           class="w-full bg-surface-hover border border-prof rounded-xl px-5 py-3 text-sm outline-none focus:border-brand transition-all" style="color: var(--prof-text-main);" required>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase tracking-widest ml-1 opacity-60" style="color: var(--prof-text-muted);">Message</label>
                    <textarea name="message" rows="4" placeholder="Votre message..." 
                              class="w-full bg-surface-hover border border-prof rounded-xl px-5 py-3 text-sm outline-none focus:border-brand transition-all resize-none" style="color: var(--prof-text-main);" required></textarea>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase tracking-widest ml-1 opacity-60" style="color: var(--prof-text-muted);">Urgence</label>
                    <select name="type" class="w-full bg-surface-hover border border-prof rounded-xl px-5 py-3 text-sm font-bold outline-none focus:border-brand transition-all" style="color: var(--prof-text-main);">
                        <option value="info">üì¢ Information</option>
                        <option value="warning">‚ö†Ô∏è Important</option>
                        <option value="success">‚úÖ Validation</option>
                    </select>
                </div>

                <button type="submit" class="w-full py-4 bg-brand text-white font-black rounded-xl hover:opacity-90 transition-all shadow-lg uppercase tracking-[0.2em] text-[10px]">
                    Envoyer
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_professor_js %}
<script>
    function toggleSeanceForm(sessionId) {
        const form = document.getElementById(`seance-form-${sessionId}`);
        form.classList.toggle('hidden');
    }

    function openNotificationModal(sessionId, sessionName) {
        const modal = document.getElementById('notification-modal');
        const form = document.getElementById('notification-form');
        const nameEl = document.getElementById('modal-session-name');
        
        form.action = `/professor/sessions/${sessionId}/notify/`;
        nameEl.textContent = sessionName;
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeNotificationModal() {
        const modal = document.getElementById('notification-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }
</script>
{% endblock %}
